services:
  mongodb:
    container_name: mongodb
    image: mongodb/mongodb-community-server:6.0-ubi8
    # Use only if volume is not a docker volume but a bind mount (e.g. ./data/:/data/db/)
    # The reason has to do with permissions (see https://stackoverflow.com/questions/29245216/write-in-shared-volumes-docker/29251160#29251160)
    # Still unclear why just setting chmod 777 ./data does not solve the issue.
    #user: 1000:1000
    network_mode: "host"
    ports:
      - 127.0.0.1:27017:27017
    volumes:
      - ./configs/mongodb_init.js:/docker-entrypoint-initdb.d/mongodb_init.js:ro
    # We use this in docker compose to have a user/password for mongodb
    # Proper deployment on a kubernetes cluster should use a helm chart
    # and parametrize a user specific to the fastAPI server.
    environment:
      - MONGODB_INITDB_ROOT_USERNAME=root
      - MONGODB_INITDB_ROOT_PASSWORD=root_pwd
      - MONGODB_INITDB_DATABASE=defaultdb
      # add user https://stackoverflow.com/questions/42912755/how-to-create-a-db-for-mongodb-container-on-start-up/54064268#54064268
  minio:
    container_name: minio
    image: minio/minio
    command: server /data
    environment:
      - MINIO_ACCESS_KEY=admin
      - MINIO_SECRET_KEY=admin123
      - ENDPOINT_URL=http://minio:9000
    ports:
      - "9000:9000"
    volumes:
      - minio-data:/data
  
  minio-client:
    image: minio/mc
    depends_on:
      - minio
    entrypoint: /bin/sh -c "
      sleep 5 && 
      cd . > penguin.csv
      mc alias set myminio http://minio:9000 admin admin123 && 
      mc mb myminio/example || true && 
      mc cp penguin.csv myminio/example/data/penguin.csv
      mc cp /lomas_server/tests/test_data/metadata/penguin_metadata.yaml myminio/example/metadata/penguin_metadata.yaml"
    volumes:
      - ./test-data:/data
