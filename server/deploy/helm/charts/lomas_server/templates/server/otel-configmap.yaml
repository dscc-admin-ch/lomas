apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-config
data:
  otel-collector-config.yaml: |
    receivers:
        otlp:
            protocols:
                grpc:
                    endpoint: 0.0.0.0:{{ .Values.otel.config.receiver.grpc_port }}
                http:
                    endpoint: 0.0.0.0:{{ .Values.otel.config.receiver.http_port }}
    processors:
        batch:
            timeout: {{ .Values.otel.config.processors.batch.timeout }}
    
    exporters:
        debug:
            verbosity: detailed

        otlp/tempo:
            endpoint: {{ .Values.otel.config.exporter.tempo_endpoint }}
            tls:
                insecure: true

        prometheus:
            endpoint: "{{ .Values.otel.config.exporter.prometheus_endpoint }}"

        otlphttp/loki:
            endpoint: {{ .Values.otel.config.exporter.loki_endpoint }}

    extensions:
        health_check:
            endpoint: "0.0.0.0:{{ .Values.otel.config.extension.health_check_port }}"
        pprof:
            endpoint: "0.0.0.0:{{ .Values.otel.config.extension.pprof_port }}"
        zpages:
            endpoint: "0.0.0.0:{{ .Values.otel.config.extension.zpages_port }}"

    service:
        extensions: [health_check, pprof, zpages]
        pipelines:
            traces:
                receivers: [otlp]
                processors: [batch]
                exporters: [debug, otlp/tempo]
            metrics:
                receivers: [otlp]
                processors: [batch]
                exporters: [debug, prometheus]
            logs:
                receivers: [otlp]
                processors: [batch]
                exporters: [debug, otlphttp/loki]
